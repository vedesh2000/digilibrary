
<div class="container">
  <h1><%=title %></h1>
  <h2>Notes by <%= ownerName  %></h2>
  <hr>
  <h2>Chapter Number: <%= chapter.chapterNumber %></h2>
  <hr>
  <h3>Title: <%= chapter.title %></h3>
  <hr>
  <h3>Description: </h3>
  <div class="description">
    <%- chapter.description %>
  </div>
  <br/>
  <h3>Notes: </h3>
  <div class="description">
    <button class="notes-button" onclick="copyText()">Copy Notes</button>
    <a href="edit/" style="margin-left: 10px; padding: 6px;" class="notes-button"><i class="fa fa-pen"></i></a>
    <br/>
    <hr/>
    <div id="audio"> 
    <label class="notes-button" for="speed">Playback Speed</label>
    <input type="number" name="speed" id="speed" min=".25" max="3" step=".25" value="1">
    <br/>
    <hr/>
    <div class="btn-group">
      <button class="notes-button" id="stop" onclick="stop();">Reset</button>
      <button class="notes-button" id="play" onclick="play();">Play</button>
      <button class="notes-button" id="pause" onclick="pause();"></button>
    </div>
    <hr/>
    <hr/>
    </div>
    <div id="notes">
      <%- chapter.sanitizedNotesMarkdown %>
    </div>
    <hr/>
  </div>
  <br>
  <div class="btn-group">
    <a href="/files/books/<%= bookId%>/notes" class="btn btn-primary">All Chapters</a>
    <a href="edit/" class="btn btn-primary">Edit Notes</a>
    <a class="btn btn-primary" onclick="generatePDF()" id="downloadButton" >Get Notes PDF</a>
    </div>
</div>

<script>
 function copyCode(event) {
    const codeElement = event.target.parentElement;
    const copyButton = event.target;
    codeElement.removeChild(copyButton);

    // Create a temporary textarea to copy the code
    const tempTextarea = document.createElement('textarea');
    tempTextarea.value = codeElement.innerText;

    // Append the textarea to the document
    document.body.appendChild(tempTextarea);

    // Select the text inside the textarea
    tempTextarea.select();

    // Copy the text to the clipboard
    document.execCommand('copy');

    // Remove the temporary textarea
    document.body.removeChild(tempTextarea);

    // Show the "Copied" message for a brief period
    codeElement.appendChild(copyButton);
    copyButton.textContent = 'Copied!';
    setTimeout(function() {
      copyButton.textContent = 'Copy Code';
    }, 1000);
  }

  // Wait for the DOM to load
  document.addEventListener('DOMContentLoaded', function() {
    const codeElements = document.querySelectorAll('.description code');

    // Create the "Copy Code" button for each code element
    codeElements.forEach(function(codeElement) {
      const copyButton = document.createElement('button');
      copyButton.textContent = 'Copy Code';
      copyButton.onclick = copyCode;
      copyButton.classList.add('copy-button');

      // Append the button to the code element
      codeElement.appendChild(copyButton);
    });
  });

function copyText() {
  // Get the content of the div
  const copyButton = document.getElementById('copy-code-button');
  const codeElement = document.querySelector('.description code');
  codeElement.removeChild(copyButton);
  var description = document.getElementById("notes").innerText;

  // Create a temporary textarea element
  var textarea = document.createElement("textarea");
  textarea.value = description;

  // Append the textarea to the document
  document.body.appendChild(textarea);

  // Select the text in the textarea
  textarea.select();
  textarea.setSelectionRange(0, 99999); // For mobile devices

  // Copy the text to the clipboard
  document.execCommand("copy");

  // Remove the temporary textarea
  document.body.removeChild(textarea);
  //Add removed copy button 
  codeElement.appendChild(copyButton);
  // Alert the user
  alert("Text copied to clipboard: " + description);
}
//Speech/////////////////////////////////////////////////////////////////////////////////////

var pauseButton = document.getElementById("pause");
var browserRefreshReq;
// Check if the browser is Microsoft Edge or Google Chrome, and not Android
var userAgent = window.navigator.userAgent;
if (userAgent.indexOf("Android") === -1) {
  pauseButton.style.display = "block"; // Show the pause button
  browserRefreshReq = false;
}
else{
  pauseButton.style.display = "none"; // Show the pause button
  browserRefreshReq = true;
}

var notesInnerHTML = document.getElementById("notes").innerText;
var pauseButton = document.getElementById("pause");
var playButton = document.getElementById("play");
var stopButton = document.getElementById("stop");
var speedButton = document.getElementById("speed");
//disbling buttons until play starts
stopButton.disabled = true;
pauseButton.disabled = true;
pauseButton.textContent = "Pause";
// Create a temporary textarea element
var textInput = document.createElement("textarea");
textInput.value = notesInnerHTML;

// Append the textInput to the document
document.body.appendChild(textInput);
let voiceCheck = window.speechSynthesis;
// console.log(voiceCheck);
if(voiceCheck){
const synth = window.speechSynthesis;
    let myPauseProperty = false;
    let utterThis;
    function stop() {
        pauseButton.disabled = true;
        pauseButton.textContent = "Pause";
        myPauseProperty = false;
        synth.cancel(utterThis);
        playButton.disabled = false;
        if(browserRefreshReq)
        window.location.reload()
    }
    function play() {
      // console.log("Start play");
      //enabling buttons until play starts
      stopButton.disabled = false;
      pauseButton.disabled = false;
      playButton.disabled = true;
      const speedInput = document.getElementById('speed').value;
        if ((myPauseProperty === true)&&(synth.speaking===true)) {//alredy started not ended
            //speech somewhere in the middle, and paused, needs resumed
            synth.resume();
            //added below line to reslove bug in android chrome
            synth.speak(utterThis);
            myPauseProperty=false;
        }
        else if (synth.speaking===false) {
            //not started or has ended, user expects to start play
            utterThis = new SpeechSynthesisUtterance(textInput.value);
            utterThis.rate = parseFloat(speedInput);
            synth.cancel();
            //adjust the speed
            synth.speak(utterThis);
            //adding to resolve pausing for long texts more than 14sec
            let r = setInterval(() => {
            // console.log(synth.speaking);
            if (!synth.speaking) {
              clearInterval(r);
            } else if(!myPauseProperty){
              synth.pause();
              synth.resume();
              //added below line to reslove bug in android chrome
              synth.speak(utterThis);
            }
            }, 14000);
            myPauseProperty=false;
        }
    }
    function pause() {
        if ((myPauseProperty === true)&&(synth.speaking===true)) {
            //speech somewhere in middle of phrase and paused, user wants unpause
            synth.resume();
            //added below line to reslove bug in android chrome
            synth.speak(utterThis);
            pauseButton.textContent = "Pause";
            myPauseProperty = false;
        }
        else if ((myPauseProperty === false)&&(synth.speaking===true)) {
            //speech somewhere in middle of phrase and unpaused, user wants pause
            synth.pause();
            myPauseProperty=true;
            pauseButton.textContent = "Resume";
        }
    }
  }
  else{
    console.log("Browser doesn't support speechSynthesis");
    var audio = document.getElementById("audio");
    audio.style.display = "none";
  }
  // Remove the temporary textInput
  document.body.removeChild(textInput);
</script>

<script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
<script>
  function addPageBreaks(notes, maxCharacters , addCharecters) {
  const words = notes.split(' ');
  let result = '';
  let currentLine = '';

  for (let i = 0; i < words.length; i++) {
    const word = words[i];
    const isHtmlTag = word.startsWith('<') && word.endsWith('>');
    const lineWithWord = currentLine.length > 0 ? currentLine + ' ' + word : word;

    if ((currentLine + ' ' + word).length <= maxCharacters && !isHtmlTag) {
      currentLine = lineWithWord;
    } else {
      if (currentLine.length > 0) {
        result += currentLine + ' ';
      }

      if (isHtmlTag) {
        result += '<br/><hr/><div style="page-break-before: always;"></div><br/><br/><hr/><br/><br/>';
      } else {
        result += '<br/><hr/><div style="page-break-before: always;"></div><br/><br/><hr/><br/><br/> ' + word;
      }

      currentLine = '';
    }
    //for remaining pages except 1st page of notes
    if(i === 0) maxCharacters += addCharecters;
  }

  if (currentLine.length > 0) {
    result += currentLine;
  }
  // console.log(result);
  return result;
}

  // Define an array to store chapter content
  function generatePDF() {
    const chapterContent = [];
    let chapterDetails
        chapterDetails = {
          chapterNumber: "<%= chapter.chapterNumber %>",
          title: "<%= chapter.title %>",
          description: `<%- chapter.description %>`,
          sanitizedNotesMarkdown: `<%- chapter.sanitizedNotesMarkdown %>`
        };
        chapterContent.push(chapterDetails);
      
      // Define the document definition for PDF
      // console.log(chapterContent); 
      let chapterWiseNotes = [
          "<div style='padding:50px; background-color: var(--color-background-dark)'>",
          "<hr/><hr/>",
          "<div style=''>",
            "<h1 class='title-header'><%= title %></h1>",
            "<h2 class='title-header'>Notes By <%= ownerName %></h2>",
            "<p>Notes Created by using DigiLibrary, try at </p>",
            "<p> www.digilibrary.onrender.com </p>",
            "<hr/><hr/>",
          "</div>",
        ]
        for (let i = 0; i < chapterContent.length; i++) {
        chapterWiseNotes.push(`<div style="page-break-before: always;"></div>`);
        chapterWiseNotes.push(`<hr/><hr/>`);
        chapterWiseNotes.push('<div class="card-body" style="margin: 0 auto;">');
        chapterWiseNotes.push(`<h3 style='font-weight: normal;' class="card-title">Chapter Number: ${chapterContent[i].chapterNumber}</h3>`);
        chapterWiseNotes.push(`<h4 style='font-weight: normal;' class="card-title">Title:</h4>`);
        chapterWiseNotes.push(`<h4 style='font-weight: normal;' class="description">${chapterContent[i].title}</h4>`);
        chapterWiseNotes.push(`<h4 style='font-weight: normal;' class="card-title">Description:</h4>`);
        chapterWiseNotes.push(`<div style='background-color: var(--color-background-text);
                                            font-weight: normal;
                                            margin: 2px;
                                            border: var(--color-text-dark);
                                            padding: 10px;
                                            border-radius: 10px;
                                            border-style: double;
                                            font-size: 0.75rem;'>${addPageBreaks(chapterContent[i].description , 2000 , 1100)}</div>`);
        chapterWiseNotes.push(`</div><div style="page-break-after: always;"></div>`);
        chapterWiseNotes.push('<div class="card-body">');
        chapterWiseNotes.push(`<h2 style='font-weight: normal;' class="card-title">Notes:</h2>`);
        chapterWiseNotes.push(`<div style='background-color: var(--color-background-text);
                                            font-weight: normal;
                                            margin: 2px;
                                            border: var(--color-text-dark);
                                            padding: 10px;
                                            border-radius: 10px;
                                            border-style: double;
                                            font-size: 0.75rem;'>${addPageBreaks(chapterContent[i].sanitizedNotesMarkdown , 2700 , 620)}</div>`);
        chapterWiseNotes.push(`</div>`);
      }
      chapterWiseNotes.push(`<div style="page-break-after: always;"></div>`);
      const title = "<%= title %>";
      const theme = document.cookie.replace(/(?:(?:^|.*;\s*)theme\s*\=\s*([^;]*).*$)|^.*$/, "$1");
      const chapterNum = "<%= chapter.chapterNumber %>";
      const content = chapterWiseNotes.join("") + "</div>";
      
      const options = {
        filename: `${title}_notes.pdf`,
        pagesplit: true,
        html2canvas: {
          scale: 1.25, // Adjust the scale for better quality
        },
        jsPDF: {
          format: "a4",
          orientation: "portrait"
        },
      };
      var downloadButton = document.getElementById('downloadButton');
      downloadButton.disabled = true;
      downloadButton.textContent = 'Preparing download...'
      // html2pdf().set(options).from(content).save();
      // Generate and save the PDF
      html2pdf()
        .set(options)
        .from(content)
        .toPdf()
        .get('pdf')
        .then(pdf => {
          // Get the total number of pages in the PDF
          const totalPages = pdf.internal.getNumberOfPages();

          // Remove the last page
          pdf.deletePage(totalPages);

          // Save the modified PDF
          pdf.save(`${title}_chapter_number_${chapterNum}_diginotes_(${theme}).pdf`);

          // console.log(`${title}_diginotes_(${theme}).pdf`);

          //enable and reset button text
          downloadButton.disabled = false;
          downloadButton.textContent = 'Get Notes PDF'
          alert("Check the Downloaded PDF, Not satisfied? please redownload, cache will improve the scales, still not satisfied please adjust overflows in the notes by editing and redownload");
        });

    };

</script>